#!/usr/bin/env node

'use strict'

var rfr = require("rfr")
var async = require("async")
var childProcess = require('child_process')
var configReader = rfr("lib/configReader")()
var forwarder = rfr("lib/forwarder")(
    rfr("lib/inputRepository")(),
    rfr("lib/forwarderServiceFactory")(),
    rfr("lib/forwarderConfigReader")()
)
var applicationExecutor = rfr("lib/applicationExecutor")(childProcess)

var config = configReader.read()
var targetApplication = process.argv.slice(2).join(" ")

async.parallel([
    (callback) => {
        forwarder
            .run(config)
            .then(
                () => callback(null, 0),
                err => callback(null, 1)
            )
    },
    (callback) => {
        applicationExecutor
            .run(targetApplication)
            .then(
                code => callback(null, code),
                err => callback(null, 1)
            )
    }
], (err, exitCode) => {
    process.exit(exitCode)
})
