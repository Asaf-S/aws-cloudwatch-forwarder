#!/usr/bin/env node

'use strict'

var rfr = require("rfr")
var async = require("async")

var programInitializer = rfr("lib/programInitializer")(
    process,
    rfr("lib/configReader")(),
    rfr("lib/applicationExecutor")(require("child_process")),
    rfr("lib/inputRepositoryFactory")(),
    rfr("lib/forwarderFactory")()
)

var programInfo = programInitializer.init()

async.parallel([
    (callback) => {
        programInfo.forwarder
            .run(programInfo.config)
            .then(
                () => callback(null, 0),
                err => callback(null, 1)
            )
    },
    (callback) => {
        programInfo.child.wait().then(
            code => callback(null, code),
            err => callback(null, 1)
        )
    }
], (err, exitCodes) => {
    var exitCode = Math.max.apply(Math, exitCodes)
    process.exit(exitCode)
})
